<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Divisão de Gastos da Festa</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f4f4f4;
    }

    h1 {
      text-align: center;
    }

    .container {
      max-width: 1100px;
      margin: 0 auto;
    }

    fieldset {
      border: 1px solid #ccc;
      margin-bottom: 20px;
      padding: 15px;
      background: #fff;
      border-radius: 8px;
    }

    legend {
      font-weight: bold;
    }

    label {
      display: inline-block;
      margin: 5px 0;
    }

    input[type="text"],
    input[type="number"],
    input[type="password"],
    select {
      padding: 4px;
      margin: 3px 0;
    }

    button {
      padding: 6px 10px;
      margin-top: 5px;
      cursor: pointer;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 10px;
      background: #fff;
    }

    table, th, td {
      border: 1px solid #ccc;
    }

    th, td {
      padding: 6px;
      text-align: left;
      font-size: 14px;
    }

    th {
      background: #eaeaea;
    }

    .small {
      font-size: 12px;
      color: #555;
    }

    .resultado {
      margin-top: 10px;
    }

    .positivo {
      color: green;
      font-weight: bold;
    }

    .negativo {
      color: red;
      font-weight: bold;
    }

    .info {
      font-size: 13px;
      color: #555;
    }

    .backup-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }

    .backup-controls input[type="file"] {
      margin-top: 5px;
    }

    .btn-small {
      font-size: 11px;
      padding: 2px 4px;
      margin: 1px 1px 0 1px;
      cursor: pointer;
    }

    tr[draggable="true"] {
      cursor: move;
    }

    .participacao-actions {
      margin-bottom: 8px;
    }

    .participacao-actions button {
      margin-right: 5px;
    }

    /* Área principal começa escondida (só aparece depois do login) */
    #areaApp {
      display: none;
    }

    textarea {
      font-family: Arial, sans-serif;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 id="tituloPagina">Controle de Gastos da Festa em Família</h1>

    <!-- LOGIN SIMPLES -->
    <fieldset id="areaLogin">
      <legend>Acesso</legend>
      <label>Seu nome:
        <input type="text" id="loginNome">
      </label>
      <br>
      <label>Senha da família:
        <input type="password" id="loginSenha">
      </label>
      <br>
      <button id="btnLogin">Entrar</button>
      <div id="loginStatus" class="small">
        Informe seu nome e a senha combinada da família.
      </div>

      <hr>
      <div class="small"><strong>Mudança de senha de entrada</strong></div>
      <label>Senha mestra:
        <input type="password" id="senhaMestra">
      </label>
      <button id="btnValidarMestra">Liberar troca</button>

      <div id="areaTrocaSenha" style="display:none; margin-top:5px;">
        <label>Nova senha da família:
          <input type="password" id="novaSenhaFamilia">
        </label>
        <button id="btnSalvarNovaSenha">Salvar nova senha</button>
        <div id="statusTrocaSenha" class="small"></div>
      </div>
    </fieldset>

    <!-- TUDO ABAIXO SÓ APARECE DEPOIS DO LOGIN -->
    <div id="areaApp">
      <!-- TÍTULO EDITÁVEL DA FESTA -->
      <fieldset>
        <legend>Nome da Festa</legend>
        <label>Título da festa:
          <input type="text" id="tituloFesta" value="Controle de Gastos da Festa em Família">
        </label>
        <div class="small">Altere aqui o nome da festa. Ele muda o título acima e o nome da aba.</div>
      </fieldset>

      <!-- PESSOAS -->
      <fieldset>
        <legend>Pessoas</legend>
        <label>Nome:
          <input type="text" id="nomePessoa">
        </label>
        <button id="btnAddPessoa">Adicionar Pessoa</button>
        <div id="listaPessoas" class="small"></div>
      </fieldset>

      <!-- REFEIÇÕES -->
      <fieldset>
        <legend>Refeições</legend>
        <label>Nome da refeição:
          <input type="text" id="nomeRefeicao">
        </label>
        <label>Custo total (R$):
          <input type="number" id="custoRefeicao" step="0.01" min="0">
        </label>
        <button id="btnAddRefeicao">Adicionar Refeição</button>
        <div id="listaRefeicoes" class="small"></div>
      </fieldset>

      <!-- PARTICIPAÇÃO NAS REFEIÇÕES -->
      <fieldset>
        <legend>Quem participou de qual refeição?</legend>
        <p class="info">
          Marque as caixas para indicar que a pessoa participou daquela refeição.
          O custo de cada refeição será dividido considerando se alguém é isento ou paga meia.
        </p>
        <div class="participacao-actions">
          <button id="btnMarcarTodos">Marcar todos (todas as refeições)</button>
          <button id="btnDesmarcarTodos">Desmarcar todos (todas as refeições)</button>
        </div>
        <div id="tabelaParticipacaoWrapper"></div>
        <div id="infoRefeicoesPorPessoa" class="small"></div>
      </fieldset>

      <!-- GASTOS / COMPRAS -->
      <fieldset>
        <legend>Gastos (Compras)</legend>
        <p class="info">
          Use esta seção para registrar quem gastou dinheiro comprando ingredientes ou qualquer coisa para a festa.
        </p>
        <label>Pessoa:
          <select id="selectGastoPessoa"></select>
        </label>
        <label>Descrição:
          <input type="text" id="descricaoGasto" placeholder="Ex: carne, refrigerante...">
        </label>
        <label>Valor (R$):
          <input type="number" id="valorGasto" step="0.01" min="0">
        </label>
        <button id="btnAddGasto">Registrar Gasto</button>
        <div id="listaGastos" class="small"></div>
      </fieldset>

      <!-- GRUPOS (RESPONSÁVEL PAGA PELOS OUTROS) -->
      <fieldset>
        <legend>Grupos (Responsável pelo Pagamento)</legend>
        <p class="info">
          Aqui você pode dizer, por exemplo, que o Pai paga pelas refeições da Esposa e dos Filhos.
          Na conta final, o saldo de todos será somado ao responsável.
        </p>
        <label>Responsável:
          <select id="selectResponsavel"></select>
        </label>
        <label>Membro do grupo:
          <select id="selectMembro"></select>
        </label>
        <button id="btnAddGrupo">Adicionar ao grupo</button>
        <div id="listaGrupos" class="small"></div>
      </fieldset>

      <!-- CÁLCULO FINAL -->
      <fieldset>
        <legend>Cálculo Final</legend>
        <button id="btnCalcular">Calcular quanto cada um paga/recebe</button>
        <div id="resultado" class="resultado"></div>
      </fieldset>

      <!-- OBSERVAÇÕES / RECADOS -->
      <fieldset>
        <legend>Observações / Recados</legend>
        <p class="info">
          Use este espaço para anotar qualquer informação importante sobre a divisão de gastos ou recados para o grupo.
        </p>
        <textarea id="observacoes" rows="4" style="width: 100%;"></textarea>
      </fieldset>

      <!-- LOG DE AÇÕES -->
      <fieldset>
        <legend>Log de ações</legend>
        <p class="info">
          Aqui você pode ver tudo o que foi feito (quem adicionou pessoa, refeição, marcou participação, etc.).
        </p>
        <button id="btnVerLog">Ver log completo</button>
        <div id="areaLog" class="small" style="margin-top: 10px;"></div>
      </fieldset>

      <!-- BACKUP / RESTAURAÇÃO (ABAIXO DO LOG) -->
      <fieldset>
        <legend>Salvar / Carregar Arquivo de Dados</legend>
        <p class="info">
          Você pode baixar um arquivo <strong>.json</strong> com todos os cadastros e depois abrir esse arquivo em outro momento ou em outro computador.
        </p>
        <div class="backup-controls">
          <button id="btnExportar">Exportar dados para arquivo (.json)</button>
          <label>
            Importar dados (.json):
            <input type="file" id="inputImportar" accept="application/json">
          </label>
        </div>
        <div id="statusBackup" class="small"></div>
      </fieldset>

    </div>
  </div>

  <!-- SCRIPT COMO MÓDULO: FIREBASE + LÓGICA -->
  <script type="module">
    // --------- FIREBASE (CDN MÓDULO) ---------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import {
      getFirestore,
      doc,
      getDoc,
      setDoc,
      collection,
      addDoc,
      getDocs,
      query,
      orderBy,
      serverTimestamp,
      deleteDoc,
      limit
    } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

    // Config do seu projeto
    const firebaseConfig = {
      apiKey: "AIzaSyBW4_sp3JsYlXkeOgmdwtDLeyyGkFDYars",
      authDomain: "festa-familia.firebaseapp.com",
      projectId: "festa-familia",
      storageBucket: "festa-familia.firebasestorage.app",
      messagingSenderId: "160850937800",
      appId: "1:160850937800:web:7b6ca8a6eba691879722fd"
    };

    // Inicializa Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Documento fixo da festa
    const festaDocRef = doc(db, "festas", "festa-principal");

    // --------- LOGIN E SENHAS ---------
    const SENHA_MESTRA = "5048558";
    let senhaFamiliaAtual = "salvador1234"; // começa com essa, mas pode ser alterada e salva

    let usuarioAtual = null;

    const areaLogin = document.getElementById("areaLogin");
    const areaApp = document.getElementById("areaApp");
    const loginNomeInput = document.getElementById("loginNome");
    const loginSenhaInput = document.getElementById("loginSenha");
    const loginStatus = document.getElementById("loginStatus");

    const senhaMestraInput = document.getElementById("senhaMestra");
    const btnValidarMestra = document.getElementById("btnValidarMestra");
    const areaTrocaSenha = document.getElementById("areaTrocaSenha");
    const novaSenhaFamiliaInput = document.getElementById("novaSenhaFamilia");
    const statusTrocaSenha = document.getElementById("statusTrocaSenha");

    document.getElementById("btnLogin").addEventListener("click", async () => {
      const nome = loginNomeInput.value.trim();
      const senha = loginSenhaInput.value;

      if (!nome || !senha) {
        loginStatus.textContent = "Preencha seu nome e a senha.";
        return;
      }

      if (senha !== senhaFamiliaAtual) {
        loginStatus.textContent = "Senha incorreta. Tente novamente.";
        return;
      }

      usuarioAtual = nome;
      loginStatus.textContent = `Bem-vindo, ${nome}!`;
      areaLogin.style.display = "none";
      areaApp.style.display = "block";

      // Carrega dados da festa e registra login no log
      await carregarDoFirestore();
      await registrarLog("Login", "Usuário entrou no sistema.");
    });

    // Validação da senha mestra para liberar troca
    btnValidarMestra.addEventListener("click", () => {
      const val = senhaMestraInput.value;
      if (val === SENHA_MESTRA) {
        areaTrocaSenha.style.display = "block";
        statusTrocaSenha.textContent =
          "Senha mestra correta. Digite a nova senha de entrada.";
      } else {
        areaTrocaSenha.style.display = "none";
        statusTrocaSenha.textContent = "Senha mestra incorreta.";
      }
    });

    // Salvar nova senha de entrada
    document.getElementById("btnSalvarNovaSenha").addEventListener("click", () => {
      const nova = novaSenhaFamiliaInput.value.trim();
      if (!nova) {
        statusTrocaSenha.textContent = "Digite uma nova senha válida.";
        return;
      }
      senhaFamiliaAtual = nova;
      novaSenhaFamiliaInput.value = "";
      senhaMestraInput.value = "";
      areaTrocaSenha.style.display = "none";
      statusTrocaSenha.textContent = "Senha de entrada alterada com sucesso.";

      salvarNoFirestore();
      registrarLog(
        "Alterar senha de entrada",
        "Senha de entrada alterada (valor não registrado por segurança)."
      );
    });

    // --------- DADOS EM MEMÓRIA ---------
    // pessoas: { id, nome, tipo } com tipo = "normal" | "isento" | "meia"
    const pessoas = [];
    const refeicoes = [];     // { id, nome, custo }
    const gastos = [];        // { pessoaId, descricao, valor }
    const grupos = [];        // { responsavelId, membroId }
    const participacao = {};  // mealId -> array de pessoaId

    let pessoaIdSeq = 1;
    let refeicaoIdSeq = 1;

    // --------- HELPERS DE STATUS ---------
    function getStatusPessoa(p) {
      return (p && p.tipo) ? p.tipo : "normal";
    }

    function getNomeComStatus(p) {
      const status = getStatusPessoa(p);
      if (status === "isento") return `${p.nome} (isento)`;
      if (status === "meia") return `${p.nome} (paga meia)`;
      return p.nome;
    }

    // --------- DOM BÁSICO ---------
    const tituloPagina = document.getElementById("tituloPagina");
    const tituloFestaInput = document.getElementById("tituloFesta");
    const observacoesInput = document.getElementById("observacoes");

    function formatMoney(valor) {
      return "R$ " + valor.toFixed(2).replace(".", ",");
    }

    // --------- LOG NO FIRESTORE (LIMITAR A 200) ---------
    async function limitarLogs(maxRegistros) {
      try {
        const q = query(collection(db, "logs"), orderBy("createdAt", "asc"));
        const snap = await getDocs(q);
        const total = snap.size;
        const excedente = total - maxRegistros;
        if (excedente > 0) {
          let count = 0;
          for (const docSnap of snap.docs) {
            if (count >= excedente) break;
            await deleteDoc(docSnap.ref);
            count++;
          }
        }
      } catch (erro) {
        console.error("Erro ao limitar logs:", erro);
      }
    }

    async function registrarLog(acao, detalhes) {
      try {
        if (!usuarioAtual) return;
        await addDoc(collection(db, "logs"), {
          usuario: usuarioAtual,
          acao,
          detalhes,
          createdAt: serverTimestamp()
        });
        await limitarLogs(200);
      } catch (erro) {
        console.error("Erro ao registrar log:", erro);
      }
    }

    // --------- ESTADO ↔ FIRESTORE ---------
    function getEstadoAtual() {
      const titulo =
        tituloFestaInput.value.trim() || "Controle de Gastos da Festa em Família";
      const observacoes = observacoesInput ? observacoesInput.value : "";
      // agora também salva a senha da família
      return {
        titulo,
        observacoes,
        senhaFamilia: senhaFamiliaAtual,
        pessoas,
        refeicoes,
        gastos,
        grupos,
        participacao
      };
    }

    async function salvarNoFirestore() {
      const status = document.getElementById("statusBackup");
      try {
        const estado = getEstadoAtual();
        await setDoc(festaDocRef, estado);
        if (status) {
          status.textContent = "Dados sincronizados com a nuvem (Firestore).";
        }
      } catch (erro) {
        console.error("Erro ao salvar no Firestore:", erro);
        if (status) {
          status.textContent = "Falha ao salvar no Firestore.";
        }
      }
    }

    async function carregarDoFirestore() {
      const status = document.getElementById("statusBackup");
      try {
        const snap = await getDoc(festaDocRef);
        if (!snap.exists()) {
          if (status) {
            status.textContent =
              "Nenhum dado na nuvem ainda. Use normalmente que será salvo no Firestore.";
          }
          if (observacoesInput) observacoesInput.value = "";
          atualizarListaPessoas();
          atualizarSelectsPessoas();
          atualizarListaRefeicoes();
          atualizarListaGastos();
          atualizarListaGrupos();
          construirTabelaParticipacao();
          return;
        }

        const obj = snap.data() || {};

        pessoas.length = 0;
        refeicoes.length = 0;
        gastos.length = 0;
        grupos.length = 0;
        for (const k in participacao) delete participacao[k];

        // senha da família vinda da nuvem (se existir)
        if (obj.senhaFamilia && typeof obj.senhaFamilia === "string") {
          senhaFamiliaAtual = obj.senhaFamilia;
        }

        if (obj.titulo) {
          tituloFestaInput.value = obj.titulo;
          const t = obj.titulo.trim() || "Controle de Gastos da Festa em Família";
          tituloPagina.textContent = t;
          document.title = t;
        }

        if (observacoesInput) {
          observacoesInput.value = obj.observacoes || "";
        }

        if (Array.isArray(obj.pessoas)) {
          obj.pessoas.forEach(p =>
            pessoas.push({
              id: p.id,
              nome: p.nome,
              tipo: p.tipo || "normal"
            })
          );
        }
        if (Array.isArray(obj.refeicoes)) {
          obj.refeicoes.forEach(r =>
            refeicoes.push({
              id: r.id,
              nome: r.nome,
              custo: Number(r.custo) || 0
            })
          );
        }
        if (Array.isArray(obj.gastos)) {
          obj.gastos.forEach(g =>
            gastos.push({
              pessoaId: g.pessoaId,
              descricao: g.descricao,
              valor: Number(g.valor) || 0
            })
          );
        }
        if (Array.isArray(obj.grupos)) {
          obj.grupos.forEach(g =>
            grupos.push({
              responsavelId: g.responsavelId,
              membroId: g.membroId
            })
          );
        }
        if (obj.participacao && typeof obj.participacao === "object") {
          for (const key in obj.participacao) {
            participacao[key] = Array.isArray(obj.participacao[key])
              ? obj.participacao[key].map(Number)
              : [];
          }
        }

        const maxPessoaId = pessoas.reduce((max, p) => Math.max(max, p.id || 0), 0);
        const maxRefeicaoId = refeicoes.reduce(
          (max, r) => Math.max(max, r.id || 0),
          0
        );
        pessoaIdSeq = maxPessoaId + 1;
        refeicaoIdSeq = maxRefeicaoId + 1;

        atualizarListaPessoas();
        atualizarSelectsPessoas();
        atualizarListaRefeicoes();
        atualizarListaGastos();
        atualizarListaGrupos();
        construirTabelaParticipacao();
        if (status) {
          status.textContent = "Dados carregados do Firestore.";
        }
      } catch (erro) {
        console.error("Erro ao carregar do Firestore:", erro);
        if (status) {
          status.textContent = "Falha ao carregar dados do Firestore.";
        }
      }
    }

    // --------- TÍTULO EDITÁVEL ---------
    tituloFestaInput.addEventListener("input", () => {
      const t = tituloFestaInput.value.trim();
      const texto = t || "Controle de Gastos da Festa em Família";
      tituloPagina.textContent = texto;
      document.title = texto;
      salvarNoFirestore();
    });

    if (observacoesInput) {
      observacoesInput.addEventListener("input", () => {
        salvarNoFirestore();
      });
    }

    // -------------- DRAG & DROP GENÉRICO --------------
    function makeTableRowsDraggable(container, arrayRef, rebuildFn) {
      const rows = container.querySelectorAll("tbody tr");
      let dragStartIndex = null;

      rows.forEach(row => {
        row.setAttribute("draggable", "true");

        row.addEventListener("dragstart", e => {
          dragStartIndex = parseInt(row.dataset.index);
          e.dataTransfer.effectAllowed = "move";
        });

        row.addEventListener("dragover", e => {
          e.preventDefault();
          e.dataTransfer.dropEffect = "move";
        });

        row.addEventListener("drop", e => {
          e.preventDefault();
          const dropIndex = parseInt(row.dataset.index);
          if (dragStartIndex === null || dropIndex === dragStartIndex) return;

          const item = arrayRef.splice(dragStartIndex, 1)[0];
          arrayRef.splice(dropIndex, 0, item);

          dragStartIndex = null;
          rebuildFn();
          salvarNoFirestore();
        });
      });
    }

    // -------------- EXPORTAÇÃO / IMPORTAÇÃO (ARQUIVO) --------------
    function getEstadoAtualParaArquivo() {
      return getEstadoAtual();
    }

    function exportarDados() {
      const data = getEstadoAtualParaArquivo();
      const json = JSON.stringify(data, null, 2);
      const blob = new Blob([json], { type: "application/json" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = "festa_dados.json";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      document.getElementById("statusBackup").textContent =
        "Arquivo exportado: festa_dados.json";
    }

    function importarDadosArquivo(arquivo) {
      const status = document.getElementById("statusBackup");
      const reader = new FileReader();
      reader.onload = function (e) {
        try {
          const texto = e.target.result;
          const obj = JSON.parse(texto);

          pessoas.length = 0;
          refeicoes.length = 0;
          gastos.length = 0;
          grupos.length = 0;
          for (const k in participacao) delete participacao[k];

          // senha da família vinda do arquivo (se existir)
          if (obj.senhaFamilia && typeof obj.senhaFamilia === "string") {
            senhaFamiliaAtual = obj.senhaFamilia;
          }

          if (obj.titulo) {
            tituloFestaInput.value = obj.titulo;
            const t = obj.titulo.trim() || "Controle de Gastos da Festa em Família";
            tituloPagina.textContent = t;
            document.title = t;
          }

          if (observacoesInput) {
            observacoesInput.value = obj.observacoes || "";
          }

          if (Array.isArray(obj.pessoas)) {
            obj.pessoas.forEach(p =>
              pessoas.push({
                id: p.id,
                nome: p.nome,
                tipo: p.tipo || "normal"
              })
            );
          }
          if (Array.isArray(obj.refeicoes)) {
            obj.refeicoes.forEach(r =>
              refeicoes.push({
                id: r.id,
                nome: r.nome,
                custo: Number(r.custo) || 0
              })
            );
          }
          if (Array.isArray(obj.gastos)) {
            obj.gastos.forEach(g =>
              gastos.push({
                pessoaId: g.pessoaId,
                descricao: g.descricao,
                valor: Number(g.valor) || 0
              })
            );
          }
          if (Array.isArray(obj.grupos)) {
            obj.grupos.forEach(g =>
              grupos.push({
                responsavelId: g.responsavelId,
                membroId: g.membroId
              })
            );
          }
          if (obj.participacao && typeof obj.participacao === "object") {
            for (const key in obj.participacao) {
              participacao[key] = Array.isArray(obj.participacao[key])
                ? obj.participacao[key].map(Number)
                : [];
            }
          }

          const maxPessoaId = pessoas.reduce((max, p) => Math.max(max, p.id || 0), 0);
          const maxRefeicaoId = refeicoes.reduce(
            (max, r) => Math.max(max, r.id || 0),
            0
          );
          pessoaIdSeq = maxPessoaId + 1;
          refeicaoIdSeq = maxRefeicaoId + 1;

          atualizarListaPessoas();
          atualizarSelectsPessoas();
          atualizarListaRefeicoes();
          atualizarListaGastos();
          atualizarListaGrupos();
          construirTabelaParticipacao();

          status.textContent = "Dados importados do arquivo com sucesso.";
          salvarNoFirestore();
          registrarLog("Importar arquivo", "Dados importados de JSON.");
        } catch (erro) {
          console.error(erro);
          status.textContent =
            "Erro ao importar arquivo. Verifique se é um JSON válido.";
        }
      };
      reader.onerror = () => {
        status.textContent = "Erro ao ler o arquivo.";
      };
      reader.readAsText(arquivo, "utf-8");
    }

    // -------------- FUNÇÕES DE EXCLUSÃO --------------
    function excluirPessoa(id) {
      const idx = pessoas.findIndex(p => p.id === id);
      if (idx !== -1) pessoas.splice(idx, 1);

      for (let i = gastos.length - 1; i >= 0; i--) {
        if (gastos[i].pessoaId === id) gastos.splice(i, 1);
      }

      for (let i = grupos.length - 1; i >= 0; i--) {
        if (grupos[i].responsavelId === id || grupos[i].membroId === id) {
          grupos.splice(i, 1);
        }
      }

      for (const rId in participacao) {
        const arr = participacao[rId];
        const i = arr.indexOf(id);
        if (i !== -1) arr.splice(i, 1);
      }

      atualizarListaPessoas();
      atualizarSelectsPessoas();
      atualizarListaGastos();
      atualizarListaGrupos();
      atualizarListaRefeicoes();
      construirTabelaParticipacao();
      salvarNoFirestore();
      registrarLog("Excluir pessoa", `ID pessoa: ${id}`);
    }

    function excluirRefeicao(id) {
      const idx = refeicoes.findIndex(r => r.id === id);
      if (idx !== -1) refeicoes.splice(idx, 1);
      delete participacao[id];
      atualizarListaRefeicoes();
      construirTabelaParticipacao();
      salvarNoFirestore();
      registrarLog("Excluir refeição", `ID refeição: ${id}`);
    }

    function excluirGasto(index) {
      if (index >= 0 && index < gastos.length) gastos.splice(index, 1);
      atualizarListaGastos();
      salvarNoFirestore();
      registrarLog("Excluir gasto", `Índice gasto: ${index}`);
    }

    function excluirGrupo(index) {
      if (index >= 0 && index < grupos.length) grupos.splice(index, 1);
      atualizarListaGrupos();
      atualizarListaPessoas();
      salvarNoFirestore();
      registrarLog("Excluir grupo", `Índice grupo: ${index}`);
    }

    // -------------- FUNÇÕES DE EDIÇÃO --------------
    function editarPessoa(id) {
      const p = pessoas.find(p => p.id === id);
      if (!p) return;
      const antigoNome = p.nome;
      const novoNome = prompt("Novo nome da pessoa:", p.nome);
      if (novoNome && novoNome.trim()) {
        p.nome = novoNome.trim();
        atualizarListaPessoas();
        atualizarSelectsPessoas();
        construirTabelaParticipacao();
        atualizarListaGastos();
        atualizarListaGrupos();
        salvarNoFirestore();
        registrarLog(
          "Editar pessoa",
          `De "${antigoNome}" para "${p.nome}"`
        );
      }
    }

    function editarRefeicao(id) {
      const r = refeicoes.find(r => r.id === id);
      if (!r) return;
      const nomeAntigo = r.nome;
      const novoNome = prompt(
        "Novo nome da refeição (deixe em branco para manter):",
        r.nome
      );
      if (novoNome !== null && novoNome.trim() !== "") {
        r.nome = novoNome.trim();
      }
      const custoAntigo = r.custo;
      const novoCustoStr = prompt(
        "Novo custo total da refeição (R$). Deixe em branco para manter:",
        r.custo.toString().replace(".", ",")
      );
      if (novoCustoStr !== null && novoCustoStr.trim() !== "") {
        const numStr = novoCustoStr.replace(",", ".");
        const valor = parseFloat(numStr);
        if (!isNaN(valor) && valor >= 0) {
          r.custo = valor;
        } else {
          alert("Valor inválido, custo mantido.");
        }
      }
      atualizarListaRefeicoes();
      construirTabelaParticipacao();
      salvarNoFirestore();
      registrarLog(
        "Editar refeição",
        `Refeição "${nomeAntigo}" (custo antigo ${formatMoney(custoAntigo)})`
      );
    }

    function editarGasto(index) {
      const g = gastos[index];
      if (!g) return;

      const descAntiga = g.descricao || "";
      const novaDesc = prompt(
        "Nova descrição (deixe em branco para manter):",
        g.descricao || ""
      );
      if (novaDesc !== null) {
        if (novaDesc.trim() !== "") g.descricao = novaDesc.trim();
      }

      const valorAntigo = g.valor;
      const valorStr = prompt(
        "Novo valor (R$). Deixe em branco para manter:",
        g.valor.toString().replace(".", ",")
      );
      if (valorStr !== null && valorStr.trim() !== "") {
        const numStr = valorStr.replace(",", ".");
        const val = parseFloat(numStr);
        if (!isNaN(val) && val > 0) {
          g.valor = val;
        } else {
          alert("Valor inválido, valor mantido.");
        }
      }

      atualizarListaGastos();
      salvarNoFirestore();
      registrarLog(
        "Editar gasto",
        `Descrição antiga "${descAntiga}", valor antigo ${formatMoney(
          valorAntigo
        )}`
      );
    }

    // -------------- UI: SELECTS, LISTAS, PARTICIPAÇÃO --------------
    function atualizarSelectsPessoas() {
      const selectGastoPessoa = document.getElementById("selectGastoPessoa");
      const selectResponsavel = document.getElementById("selectResponsavel");
      const selectMembro = document.getElementById("selectMembro");

      [selectGastoPessoa, selectResponsavel, selectMembro].forEach(
        sel => (sel.innerHTML = "")
      );

      pessoas.forEach(p => {
        const opt1 = document.createElement("option");
        opt1.value = p.id;
        opt1.textContent = p.nome;
        selectGastoPessoa.appendChild(opt1);

        const opt2 = document.createElement("option");
        opt2.value = p.id;
        opt2.textContent = p.nome;
        selectResponsavel.appendChild(opt2);

        const opt3 = document.createElement("option");
        opt3.value = p.id;
        opt3.textContent = p.nome;
        selectMembro.appendChild(opt3);
      });
    }

    function atualizarListaPessoas() {
      const div = document.getElementById("listaPessoas");
      if (pessoas.length === 0) {
        div.textContent = "Nenhuma pessoa cadastrada ainda.";
        return;
      }

      let html =
        "<table><thead><tr><th>Nome</th><th>Ações</th></tr></thead><tbody>";
      pessoas.forEach((p, index) => {
        const grupoDoMembro = grupos.find(g => g.membroId === p.id);
        let nomeComResponsavel = getNomeComStatus(p);
        if (grupoDoMembro) {
          const resp = pessoas.find(x => x.id === grupoDoMembro.responsavelId);
          if (resp) {
            nomeComResponsavel += ` (Responsável: ${resp.nome})`;
          }
        }

        const status = getStatusPessoa(p);

        html += `<tr data-index="${index}">
          <td>${nomeComResponsavel}</td>
          <td>
            <select class="select-status" data-id="${p.id}">
              <option value="normal" ${status === "normal" ? "selected" : ""}>Normal</option>
              <option value="isento" ${status === "isento" ? "selected" : ""}>Isento</option>
              <option value="meia" ${status === "meia" ? "selected" : ""}>Paga meia</option>
            </select>
            <button class="btn-small" data-acao="editar-pessoa" data-id="${p.id}">Editar</button>
            <button class="btn-small" data-acao="excluir-pessoa" data-id="${p.id}">Excluir</button>
          </td>
        </tr>`;
      });
      html += "</tbody></table>";
      div.innerHTML = html;

      // handlers status
      div.querySelectorAll(".select-status").forEach(sel => {
        sel.addEventListener("change", () => {
          const id = parseInt(sel.getAttribute("data-id"));
          const p = pessoas.find(p => p.id === id);
          if (!p) return;
          p.tipo = sel.value;
          salvarNoFirestore();
          atualizarListaPessoas();
          construirTabelaParticipacao();
          registrarLog(
            "Alterar status pessoa",
            `Pessoa: ${p.nome}, status: ${sel.value}`
          );
        });
      });

      div
        .querySelectorAll("button[data-acao='excluir-pessoa']")
        .forEach(btn => {
          btn.addEventListener("click", () => {
            const id = parseInt(btn.getAttribute("data-id"));
            if (confirm("Excluir essa pessoa e todos os dados relacionados?")) {
              excluirPessoa(id);
            }
          });
        });

      div
        .querySelectorAll("button[data-acao='editar-pessoa']")
        .forEach(btn => {
          btn.addEventListener("click", () => {
            const id = parseInt(btn.getAttribute("data-id"));
            editarPessoa(id);
          });
        });

      const table = div.querySelector("table");
      makeTableRowsDraggable(table, pessoas, () => {
        atualizarListaPessoas();
        atualizarSelectsPessoas();
        construirTabelaParticipacao();
        atualizarListaGastos();
        atualizarListaGrupos();
      });
    }

    function atualizarListaRefeicoes() {
      const div = document.getElementById("listaRefeicoes");
      if (refeicoes.length === 0) {
        div.textContent = "Nenhuma refeição cadastrada ainda.";
        return;
      }

      let total = 0;
      let html =
        "<table><thead><tr><th>Refeição</th><th>Custo</th><th>Ações</th></tr></thead><tbody>";
      refeicoes.forEach((r, index) => {
        total += r.custo;
        html += `<tr data-index="${index}">
          <td>${r.nome}</td>
          <td>${formatMoney(r.custo)}</td>
          <td>
            <button class="btn-small" data-acao="editar-refeicao" data-id="${r.id}">Editar</button>
            <button class="btn-small" data-acao="excluir-refeicao" data-id="${r.id}">Excluir</button>
          </td>
        </tr>`;
      });
      html += `</tbody></table><br><strong>Total de todas as refeições: ${formatMoney(
        total
      )}</strong>`;
      div.innerHTML = html;

      div
        .querySelectorAll("button[data-acao='excluir-refeicao']")
        .forEach(btn => {
          btn.addEventListener("click", () => {
            const id = parseInt(btn.getAttribute("data-id"));
            if (
              confirm("Excluir essa refeição e as participações ligadas a ela?")
            ) {
              excluirRefeicao(id);
            }
          });
        });

      div
        .querySelectorAll("button[data-acao='editar-refeicao']")
        .forEach(btn => {
          btn.addEventListener("click", () => {
            const id = parseInt(btn.getAttribute("data-id"));
            editarRefeicao(id);
          });
        });

      const table = div.querySelector("table");
      makeTableRowsDraggable(table, refeicoes, () => {
        atualizarListaRefeicoes();
        construirTabelaParticipacao();
      });
    }

    function atualizarListaGastos() {
      const div = document.getElementById("listaGastos");
      if (gastos.length === 0) {
        div.textContent = "Nenhum gasto registrado ainda.";
        return;
      }

      let total = 0;
      let html =
        "<table><thead><tr><th>Pessoa</th><th>Descrição</th><th>Valor</th><th>Ações</th></tr></thead><tbody>";
      gastos.forEach((g, index) => {
        const pessoa = pessoas.find(p => p.id === g.pessoaId);
        total += g.valor;
        html += `<tr data-index="${index}">
          <td>${pessoa ? pessoa.nome : "?"}</td>
          <td>${g.descricao || "sem descrição"}</td>
          <td>${formatMoney(g.valor)}</td>
          <td>
            <button class="btn-small" data-acao="editar-gasto" data-index="${index}">Editar</button>
            <button class="btn-small" data-acao="excluir-gasto" data-index="${index}">Excluir</button>
          </td>
        </tr>`;
      });
      html += `</tbody></table><br><strong>Total de todos os gastos: ${formatMoney(
        total
      )}</strong>`;
      div.innerHTML = html;

      div
        .querySelectorAll("button[data-acao='excluir-gasto']")
        .forEach(btn => {
          btn.addEventListener("click", () => {
            const index = parseInt(btn.getAttribute("data-index"));
            if (confirm("Excluir esse gasto?")) {
              excluirGasto(index);
            }
          });
        });

      div
        .querySelectorAll("button[data-acao='editar-gasto']")
        .forEach(btn => {
          btn.addEventListener("click", () => {
            const index = parseInt(btn.getAttribute("data-index"));
            editarGasto(index);
          });
        });

      const table = div.querySelector("table");
      makeTableRowsDraggable(table, gastos, () => {
        atualizarListaGastos();
      });
    }

    function atualizarListaGrupos() {
      const div = document.getElementById("listaGrupos");
      if (grupos.length === 0) {
        div.textContent = "Nenhum grupo definido ainda.";
        return;
      }

      let html =
        "<table><thead><tr><th>Membro</th><th>Responsável</th><th>Ações</th></tr></thead><tbody>";
      grupos.forEach((g, index) => {
        const resp = pessoas.find(p => p.id === g.responsavelId);
        const memb = pessoas.find(p => p.id === g.membroId);
        html += `<tr data-index="${index}">
          <td>${memb ? memb.nome : "?"}</td>
          <td>${resp ? resp.nome : "?"}</td>
          <td>
            <button class="btn-small" data-acao="excluir-grupo" data-index="${index}">Excluir</button>
          </td>
        </tr>`;
      });
      html += "</tbody></table>";
      div.innerHTML = html;

      div
        .querySelectorAll("button[data-acao='excluir-grupo']")
        .forEach(btn => {
          btn.addEventListener("click", () => {
            const index = parseInt(btn.getAttribute("data-index"));
            if (confirm("Excluir esse agrupamento?")) {
              excluirGrupo(index);
            }
          });
        });

      const table = div.querySelector("table");
      makeTableRowsDraggable(table, grupos, () => {
        atualizarListaGrupos();
      });
    }

    // --------- RESUMO DAS REFEIÇÕES: VALOR POR PESSOA / MEIA ---------
    function atualizarInfoRefeicoesPorPessoa() {
      const div = document.getElementById("infoRefeicoesPorPessoa");
      if (refeicoes.length === 0) {
        div.textContent = "";
        return;
      }
      let html = "<strong>Resumo das refeições:</strong><br>";
      refeicoes.forEach(r => {
        const part = participacao[r.id] || [];
        const n = part.length;
        if (n === 0) {
          html += `"${r.nome}" → ainda sem participantes.<br>`;
        } else {
          let normais = 0, meias = 0, isentos = 0;
          let totalPeso = 0;

          part.forEach(pId => {
            const pessoa = pessoas.find(p => p.id === pId);
            const tipo = getStatusPessoa(pessoa);
            if (tipo === "isento") {
              isentos++;
              // peso 0
            } else if (tipo === "meia") {
              meias++;
              totalPeso += 0.5;
            } else {
              normais++;
              totalPeso += 1;
            }
          });

          if (totalPeso <= 0) {
            // todo mundo isento
            html += `"${r.nome}" → todos os participantes são isentos, ninguém paga nada. (${n} participante(s)).<br>`;
          } else {
            const valorPorPeso = r.custo / totalPeso;
            const valorNormal = valorPorPeso;       // peso 1
            const valorMeia = valorPorPeso * 0.5;   // peso 0.5

            let linha = `"${r.nome}" → `;

            if (normais > 0) {
              linha += `${formatMoney(valorNormal)} por pessoa`;
              if (meias > 0) linha += " normal";
            }

            if (meias > 0) {
              if (normais > 0) {
                linha += ` e ${formatMoney(valorMeia)} para quem paga meia`;
              } else {
                linha += `${formatMoney(valorMeia)} por pessoa (paga meia)`;
              }
            }

            linha += ` (${n} participante(s): normais: ${normais}, meia: ${meias}, isento: ${isentos}).<br>`;
            html += linha;
          }
        }
      });
      div.innerHTML = html;
    }

    // Tabela de participação (com botões por coluna)
    function construirTabelaParticipacao() {
      const wrapper = document.getElementById("tabelaParticipacaoWrapper");
      if (pessoas.length === 0 || refeicoes.length === 0) {
        wrapper.innerHTML =
          "<p class='small'>Cadastre pelo menos uma pessoa e uma refeição para marcar as participações.</p>";
        document.getElementById("infoRefeicoesPorPessoa").textContent = "";
        return;
      }

      let html = "<table><thead><tr><th>Pessoa</th>";
      refeicoes.forEach(r => {
        html += `<th>
          ${r.nome}<br>
          <span class="small">${formatMoney(r.custo)}</span><br>
          <button class="btn-small" data-acao="mark-col" data-refeicao="${r.id}">✓</button>
          <button class="btn-small" data-acao="unmark-col" data-refeicao="${r.id}">✕</button>
        </th>`;
      });
      html += "</tr></thead><tbody>";

      pessoas.forEach(p => {
        html += `<tr><td>${getNomeComStatus(p)}</td>`;
        refeicoes.forEach(r => {
          const jaParticipa =
            participacao[r.id] && participacao[r.id].includes(p.id);
          html += `<td style="text-align:center">
            <input type="checkbox"
                   data-pessoa="${p.id}"
                   data-refeicao="${r.id}"
                   ${jaParticipa ? "checked" : ""}>
          </td>`;
        });
        html += "</tr>";
      });

      html += "</tbody></table>";
      wrapper.innerHTML = html;

      const checkboxes = wrapper.querySelectorAll("input[type='checkbox']");
      checkboxes.forEach(chk => {
        chk.addEventListener("change", function () {
          const pessoaId = parseInt(this.getAttribute("data-pessoa"));
          const refeicaoId = parseInt(this.getAttribute("data-refeicao"));

          if (!participacao[refeicaoId]) participacao[refeicaoId] = [];
          const arr = participacao[refeicaoId];
          const idx = arr.indexOf(pessoaId);

          if (this.checked && idx === -1) arr.push(pessoaId);
          else if (!this.checked && idx !== -1) arr.splice(idx, 1);

          atualizarInfoRefeicoesPorPessoa();
          salvarNoFirestore();

          const pessoa = pessoas.find(p => p.id === pessoaId);
          const refeicao = refeicoes.find(r => r.id === refeicaoId);
          const nomePessoa = pessoa ? pessoa.nome : `Pessoa #${pessoaId}`;
          const nomeRefeicao = refeicao ? refeicao.nome : `refeição #${refeicaoId}`;

          let detalhes;
          if (this.checked) {
            detalhes = `${nomePessoa} foi adicionado ao ${nomeRefeicao}.`;
          } else {
            detalhes = `${nomePessoa} foi retirado do ${nomeRefeicao}.`;
          }

          registrarLog("Alterar participação", detalhes);
        });
      });

      wrapper
        .querySelectorAll("button[data-acao='mark-col']")
        .forEach(btn => {
          btn.addEventListener("click", () => {
            const refeicaoId = parseInt(btn.getAttribute("data-refeicao"));
            participacao[refeicaoId] = pessoas.map(p => p.id);
            construirTabelaParticipacao();
            salvarNoFirestore();

            const refeicao = refeicoes.find(r => r.id === refeicaoId);
            const nomeRefeicao = refeicao ? refeicao.nome : `refeição #${refeicaoId}`;
            registrarLog(
              "Marcar todos em refeição",
              `Todos foram adicionados ao ${nomeRefeicao}.`
            );
          });
        });

      wrapper
        .querySelectorAll("button[data-acao='unmark-col']")
        .forEach(btn => {
          btn.addEventListener("click", () => {
            const refeicaoId = parseInt(btn.getAttribute("data-refeicao"));
            participacao[refeicaoId] = [];
            construirTabelaParticipacao();
            salvarNoFirestore();

            const refeicao = refeicoes.find(r => r.id === refeicaoId);
            const nomeRefeicao = refeicoes ? refeicao.nome : `refeição #${refeicaoId}`;
            registrarLog(
              "Desmarcar todos em refeição",
              `Todos foram removidos do ${nomeRefeicao}.`
            );
          });
        });

      atualizarInfoRefeicoesPorPessoa();
    }

    // -------------- CÁLCULO PRINCIPAL --------------
    function calcularTudo() {
      if (pessoas.length === 0 || refeicoes.length === 0) {
        return null;
      }

      const devePagar = {};
      const gastou = {};
      const saldoIndividual = {};
      const saldoFinal = {};
      const detalhesRefeicoesPorPessoa = {};
      const totalRefeicoesPorPessoa = {};

      pessoas.forEach(p => {
        devePagar[p.id] = 0;
        gastou[p.id] = 0;
        saldoIndividual[p.id] = 0;
        saldoFinal[p.id] = 0;
        detalhesRefeicoesPorPessoa[p.id] = [];
        totalRefeicoesPorPessoa[p.id] = 0;
      });

      // Refeições com peso por status (normal = 1, meia = 0.5, isento = 0)
      refeicoes.forEach(r => {
        const participantes = participacao[r.id] || [];
        if (participantes.length === 0) return;

        let totalPeso = 0;
        const pesosPorPessoa = {};

        participantes.forEach(pId => {
          const pessoa = pessoas.find(p => p.id === pId);
          const status = getStatusPessoa(pessoa);
          let peso = 1;
          if (status === "isento") peso = 0;
          else if (status === "meia") peso = 0.5;
          pesosPorPessoa[pId] = peso;
          totalPeso += peso;
        });

        // Se todos forem isentos, ninguém paga essa refeição
        if (totalPeso <= 0) return;

        const valorPorPeso = r.custo / totalPeso;

        participantes.forEach(pId => {
          const peso = pesosPorPessoa[pId];
          const valorPessoa = valorPorPeso * peso;
          devePagar[pId] += valorPessoa;
          detalhesRefeicoesPorPessoa[pId].push({
            refeicaoId: r.id,
            valor: valorPessoa
          });
          totalRefeicoesPorPessoa[pId] += valorPessoa;
        });
      });

      // Gastos
      gastos.forEach(g => {
        if (gastou[g.pessoaId] === undefined) gastou[g.pessoaId] = 0;
        gastou[g.pessoaId] += g.valor;
      });
      pessoas.forEach(p => {
        if (gastou[p.id] === undefined) gastou[p.id] = 0;
      });

      // Saldo individual (sem grupos)
      pessoas.forEach(p => {
        saldoIndividual[p.id] = gastou[p.id] - devePagar[p.id];
        saldoFinal[p.id] = saldoIndividual[p.id];
      });

      // Aplicar grupos (somar membros no responsável)
      grupos.forEach(g => {
        const rId = g.responsavelId;
        const mId = g.membroId;
        if (rId === mId) return;
        saldoFinal[rId] += saldoFinal[mId];
        saldoFinal[mId] = 0;
      });

      return {
        devePagar,
        gastou,
        saldoIndividual,
        saldoFinal,
        detalhesRefeicoesPorPessoa,
        totalRefeicoesPorPessoa
      };
    }

    // -------------- EVENTOS PRINCIPAIS --------------
    document.getElementById("btnAddPessoa").addEventListener("click", () => {
      const nome = document.getElementById("nomePessoa").value.trim();
      if (!nome) {
        alert("Digite o nome da pessoa.");
        return;
      }
      pessoas.push({ id: pessoaIdSeq++, nome, tipo: "normal" });
      document.getElementById("nomePessoa").value = "";
      atualizarListaPessoas();
      atualizarSelectsPessoas();
      construirTabelaParticipacao();
      salvarNoFirestore();
      registrarLog("Adicionar pessoa", `Pessoa: ${nome}`);
    });

    document.getElementById("btnAddRefeicao").addEventListener("click", () => {
      const nome = document.getElementById("nomeRefeicao").value.trim();
      const custoStr = document.getElementById("custoRefeicao").value;
      const custo = parseFloat(custoStr);

      if (!nome) {
        alert("Digite o nome da refeição.");
        return;
      }
      if (isNaN(custo) || custo < 0) {
        alert("Digite um custo válido para a refeição.");
        return;
      }

      refeicoes.push({ id: refeicaoIdSeq++, nome, custo });
      document.getElementById("nomeRefeicao").value = "";
      document.getElementById("custoRefeicao").value = "";
      atualizarListaRefeicoes();
      construirTabelaParticipacao();
      salvarNoFirestore();
      registrarLog("Adicionar refeição", `Refeição: ${nome}, custo ${formatMoney(custo)}`);
    });

    document.getElementById("btnAddGasto").addEventListener("click", () => {
      if (pessoas.length === 0) {
        alert("Cadastre pelo menos uma pessoa antes de registrar gastos.");
        return;
      }
      const select = document.getElementById("selectGastoPessoa");
      const pessoaId = parseInt(select.value);
      const descricao = document.getElementById("descricaoGasto").value.trim();
      const valorStr = document.getElementById("valorGasto").value;
      const valor = parseFloat(valorStr);

      if (isNaN(valor) || valor <= 0) {
        alert("Digite um valor de gasto válido.");
        return;
      }

      gastos.push({ pessoaId, descricao, valor });
      document.getElementById("descricaoGasto").value = "";
      document.getElementById("valorGasto").value = "";
      atualizarListaGastos();
      salvarNoFirestore();

      const pessoa = pessoas.find(p => p.id === pessoaId);
      registrarLog(
        "Adicionar gasto",
        `Pessoa: ${pessoa ? pessoa.nome : "?"}, valor ${formatMoney(valor)}, desc "${descricao}"`
      );
    });

    document.getElementById("btnAddGrupo").addEventListener("click", () => {
      if (pessoas.length < 2) {
        alert("É preciso ter pelo menos duas pessoas para criar um grupo.");
        return;
      }
      const responsavelId = parseInt(
        document.getElementById("selectResponsavel").value
      );
      const membroId = parseInt(
        document.getElementById("selectMembro").value
      );

      if (responsavelId === membroId) {
        alert("Responsável e membro não podem ser a mesma pessoa.");
        return;
      }

      const jaExiste = grupos.some(
        g => g.responsavelId === responsavelId && g.membroId === membroId
      );
      if (jaExiste) {
        alert("Esse membro já está nesse grupo.");
        return;
      }

      grupos.push({ responsavelId, membroId });
      atualizarListaGrupos();
      atualizarListaPessoas();
      salvarNoFirestore();

      const resp = pessoas.find(p => p.id === responsavelId);
      const memb = pessoas.find(p => p.id === membroId);
      registrarLog(
        "Adicionar grupo",
        `Responsável: ${resp ? resp.nome : "?"}, membro: ${memb ? memb.nome : "?"}`
      );
    });

    // Global marcar/desmarcar todos
    document.getElementById("btnMarcarTodos").addEventListener("click", () => {
      if (pessoas.length === 0 || refeicoes.length === 0) {
        alert("Cadastre pessoas e refeições primeiro.");
        return;
      }
      refeicoes.forEach(r => {
        participacao[r.id] = pessoas.map(p => p.id);
      });
      construirTabelaParticipacao();
      salvarNoFirestore();
      registrarLog("Marcar todos", "Todas as pessoas em todas as refeições.");
    });

    document
      .getElementById("btnDesmarcarTodos")
      .addEventListener("click", () => {
        if (refeicoes.length === 0) return;
        refeicoes.forEach(r => {
          participacao[r.id] = [];
        });
        construirTabelaParticipacao();
        salvarNoFirestore();
        registrarLog("Desmarcar todos", "Removidas todas as participações.");
      });

    // Cálculo com tabela detalhada (AJUSTADO PARA GRUPOS EM CADEIA)
    document.getElementById("btnCalcular").addEventListener("click", () => {
      const divResultado = document.getElementById("resultado");

      const calc = calcularTudo();
      if (!calc) {
        divResultado.innerHTML =
          "<p class='small'>Cadastre pelo menos uma pessoa e uma refeição para calcular.</p>";
        return;
      }

      const {
        devePagar,
        gastou,
        saldoIndividual,
        saldoFinal,
        detalhesRefeicoesPorPessoa,
        totalRefeicoesPorPessoa
      } = calc;

      // mapa membro -> responsável direto
      const responsavelDireto = {};
      grupos.forEach(g => {
        responsavelDireto[g.membroId] = g.responsavelId;
      });

      // encontra o responsável final (topo da cadeia)
      function getResponsavelTopo(id) {
        let atual = id;
        const visitados = new Set();
        while (responsavelDireto[atual] !== undefined && !visitados.has(atual)) {
          visitados.add(atual);
          atual = responsavelDireto[atual];
        }
        return atual;
      }

      // agrupa todas as pessoas por responsável final
      const contribPorTopo = {};
      pessoas.forEach(p => {
        const topo = getResponsavelTopo(p.id);
        if (!contribPorTopo[topo]) contribPorTopo[topo] = [];
        contribPorTopo[topo].push(p.id);
      });

      let html =
        "<table><thead><tr>" +
        "<th>Pessoa</th>" +
        "<th>Deveria pagar (refeições)</th>" +
        "<th>Gastou (compras)</th>" +
        "<th>Saldo</th>" +
        "<th>Situação + Detalhamento</th>" +
        "</tr></thead><tbody>";

      pessoas.forEach(p => {
        const d = devePagar[p.id] || 0;
        const g = gastou[p.id] || 0;
        const sFinal = saldoFinal[p.id] || 0;
        const sIndiv = saldoIndividual[p.id] || 0;

        const topo = getResponsavelTopo(p.id);
        const membrosDoMeuTopo = contribPorTopo[topo] || [];
        const souTopo = topo === p.id;

        let situacao = "";
        let classe = "";

        if (sFinal > 0.009) {
          situacao = `Deve receber ${formatMoney(sFinal)}`;
          classe = "positivo";
        } else if (sFinal < -0.009) {
          situacao = `Deve pagar ${formatMoney(-sFinal)}`;
          classe = "negativo";
        } else {
          situacao = "Equilibrado (não paga nem recebe)";
        }

        const detalhes = detalhesRefeicoesPorPessoa[p.id] || [];
        let textoRefeicoes;
        if (detalhes.length === 0) {
          textoRefeicoes = "Não participou de nenhuma refeição.";
        } else {
          const partes = detalhes.map(detalhe => {
            const ref = refeicoes.find(r => r.id === detalhe.refeicaoId);
            const nomeRef = ref ? ref.nome : `Refeição #${detalhe.refeicaoId}`;
            return `${formatMoney(detalhe.valor)} de "${nomeRef}"`;
          });
          textoRefeicoes = partes.join(" + ");
        }
        const totalRef = totalRefeicoesPorPessoa[p.id] || 0;

        let resumo =
          `Refeições: ${textoRefeicoes} → total das refeições: ${formatMoney(
            totalRef
          )}. ` + `Gastou em compras: ${formatMoney(g)}. `;

        if (sIndiv > 0.009) {
          resumo += `Saldo individual (sem grupos): tem a receber ${formatMoney(
            sIndiv
          )}. `;
        } else if (sIndiv < -0.009) {
          resumo += `Saldo individual (sem grupos): tem a pagar ${formatMoney(
            -sIndiv
          )}. `;
        } else {
          resumo += "Saldo individual (sem grupos): ficou zerado. ";
        }

        // membros diretos deste responsável (para texto intermediário)
        const meusMembrosDiretos = grupos
          .filter(gp => gp.responsavelId === p.id)
          .map(gp => gp.membroId);

        // Se sou o responsável final (topo) de um grupo com mais pessoas,
        // explico que o saldo final inclui todo mundo da cadeia.
        if (souTopo && membrosDoMeuTopo.length > 1) {
          const partesMembrosTopo = membrosDoMeuTopo
            .filter(idM => idM !== p.id)
            .map(idM => {
              const pessoaM = pessoas.find(x => x.id === idM);
              const sM = saldoIndividual[idM] || 0;
              const nomeM = pessoaM ? pessoaM.nome : `Pessoa #${idM}`;
              if (sM > 0.009) {
                return `${nomeM}: tem a receber ${formatMoney(sM)}`;
              } else if (sM < -0.009) {
                return `${nomeM}: tem a pagar ${formatMoney(-sM)}`;
              } else {
                return `${nomeM}: saldo zerado`;
              }
            });
          if (partesMembrosTopo.length > 0) {
            resumo += `Este saldo final inclui também os saldos de: ${partesMembrosTopo.join(
              "; "
            )}. `;
          }
        } else if (!souTopo && meusMembrosDiretos.length > 0) {
          // Responsável intermediário (como a Camila): mostra quem ela cobre,
          // mas avisa que o saldo foi repassado para o topo.
          const partesDiretos = meusMembrosDiretos.map(idM => {
            const pessoaM = pessoas.find(x => x.id === idM);
            return pessoaM ? pessoaM.nome : `Pessoa #${idM}`;
          });
          const topoPessoa = pessoas.find(x => x.id === topo);
          resumo += `É responsável diretamente por: ${partesDiretos.join(
            ", "
          )}. `;
          if (topoPessoa && topoPessoa.id !== p.id) {
            resumo += `No entanto, o saldo desse grupo foi transferido para o responsável final ${topoPessoa.nome}. `;
          }
        }

        // Texto do saldo final: se sou topo de grupo, fala "saldo do grupo",
        // senão fala "saldo final" normal.
        if (souTopo && membrosDoMeuTopo.length > 1) {
          if (sFinal > 0.009) {
            resumo += `Saldo final do grupo (responsável ${p.nome}): tem a receber ${formatMoney(
              sFinal
            )}.`;
          } else if (sFinal < -0.009) {
            resumo += `Saldo final do grupo (responsável ${p.nome}): tem a pagar ${formatMoney(
              -sFinal
            )}.`;
          } else {
            resumo += `Saldo final do grupo (responsável ${p.nome}): ficou zerado.`;
          }
        } else {
          if (sFinal > 0.009) {
            resumo += `Saldo final: tem a receber ${formatMoney(sFinal)}.`;
          } else if (sFinal < -0.009) {
            resumo += "Saldo final: tem a pagar " + formatMoney(-sFinal) + ".";
          } else {
            resumo += "Saldo final: ficou zerado.";
          }
        }

        // Se a pessoa é membro de algum grupo, explica onde o saldo dela foi considerado
        const ehMembro = responsavelDireto[p.id] !== undefined;
        if (ehMembro) {
          const respId = responsavelDireto[p.id];
          const respPessoa = pessoas.find(x => x.id === respId);
          const topoPessoa = pessoas.find(x => x.id === topo);
          if (respPessoa && topoPessoa && topoPessoa.id !== respPessoa.id) {
            resumo += ` (Saldo individual considerado no responsável ${respPessoa.nome} e, ao final, no responsável principal ${topoPessoa.nome}.)`;
          } else if (respPessoa) {
            resumo += ` (Saldo individual considerado no responsável: ${respPessoa.nome}.)`;
          } else {
            resumo += " (Saldo individual considerado em um responsável de grupo.)";
          }
        }

        html +=
          "<tr>" +
          `<td>${getNomeComStatus(p)}</td>` +
          `<td>${formatMoney(d)}</td>` +
          `<td>${formatMoney(g)}</td>` +
          `<td class="${classe}">${formatMoney(sFinal)}</td>` +
          `<td>${situacao}<br><span class="small">${resumo}</span></td>` +
          "</tr>";
      });

      html += "</tbody></table>";
      divResultado.innerHTML = html;

      registrarLog("Calcular", "Recalculo das contas executado.");
    });

    // Exportar / importar arquivo
    document.getElementById("btnExportar").addEventListener("click", () => {
      exportarDados();
    });

    document
      .getElementById("inputImportar")
      .addEventListener("change", e => {
        const arquivo = e.target.files[0];
        if (arquivo) {
          importarDadosArquivo(arquivo);
          e.target.value = "";
        }
      });

    // Botão para ver log (somente últimos 200, mais recentes em cima)
    document.getElementById("btnVerLog").addEventListener("click", async () => {
      const divLog = document.getElementById("areaLog");
      divLog.textContent = "Carregando log...";
      try {
        const q = query(
          collection(db, "logs"),
          orderBy("createdAt", "desc"),
          limit(200)
        );
        const snap = await getDocs(q);
        if (snap.empty) {
          divLog.textContent = "Nenhum registro ainda.";
          return;
        }

        let html = "<ul>";
        snap.forEach(docSnap => {
          const data = docSnap.data();
          const nome = data.usuario || "(sem nome)";
          const acao = data.acao || "";
          const detalhes = data.detalhes || "";
          let dataStr = "";
          if (data.createdAt) {
            const d = data.createdAt.toDate();
            dataStr = d.toLocaleString("pt-BR");
          }
          html += `<li><strong>${dataStr}</strong> - ${nome}: ${acao} — ${detalhes}</li>`;
        });
        html += "</ul>";
        divLog.innerHTML = html;
      } catch (erro) {
        console.error(erro);
        divLog.textContent = "Erro ao carregar log.";
      }
    });
  </script>
</body>
</html>
